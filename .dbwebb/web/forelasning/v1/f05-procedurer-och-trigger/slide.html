<!doctype html>
<html class="theme-5">
<meta charset="utf-8" />
<link href="../html-slideshow.bundle.min.css" rel="stylesheet" />
<link href="../style.css" rel="stylesheet" />
<script src="https://dbwebb.se/cdn/js/html-slideshow_v1.1.0.bundle.min.js"></script>

<title>Kursen databas</title>

<script data-role="slide" type="text/html" data-markdown class="titlepage center">
# Procedurer och triggers
## Programmera i databasen
### Mikael Roos
</script>



<script data-role="slide" data-markdown type="text/html">
# Agenda

* Tidsstämplar
* Programmera i databasen
* Compound statement syntax
* Lagrad procedur
* Trigger
* JavaScript till lagrad procedur

</script>



<script data-role="slide" data-markdown type="text/html" class="titlepage center">
# Om Tidstämplar

<p class="footnote">Exempelkoden för detta exemepl finns i https://github.com/dbwebb-se/databas/blob/master/example/sql/timestamp.sql.</p>

</script>



<script data-role="slide" data-markdown type="text/html">
# Tidstämplar

* När raden skapas
* När raden uppdateras
* När raden "raderas"
	* Soft delete

</script>



<script data-role="slide" data-markdown type="text/html">
# Skapa tabellen

```
DROP TABLE IF EXISTS t1;

CREATE TABLE t1 (
    id INTEGER AUTO_INCREMENT PRIMARY KEY,
    value CHAR(2),
    created TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated TIMESTAMP DEFAULT NULL
                             ON UPDATE CURRENT_TIMESTAMP,
    deleted TIMESTAMP DEFAULT NULL
);
```

</script>



<script data-role="slide" data-markdown type="text/html">
# Lägg in värden

```
INSERT INTO t1 (value) VALUES
    ('A'), ('B'), ('C');
```

```
mysql> INSERT INTO t1 (value) VALUES
    ->     ('A'), ('B'), ('C');
Query OK, 3 rows affected (0.02 sec)
Records: 3  Duplicates: 0  Warnings: 0
```

</script>



<script data-role="slide" data-markdown type="text/html">
# Lägg in värden...

```
mysql> SELECT * FROM t1;
+----+-------+---------------------+---------+---------+
| id | value | created             | updated | deleted |
+----+-------+---------------------+---------+---------+
|  1 | A     | 2021-02-18 13:20:59 | NULL    | NULL    |
|  2 | B     | 2021-02-18 13:20:59 | NULL    | NULL    |
|  3 | C     | 2021-02-18 13:20:59 | NULL    | NULL    |
+----+-------+---------------------+---------+---------+
3 rows in set (0.00 sec)
```

</script>



<script data-role="slide" data-markdown type="text/html">
# Tidstämpel created

```
CREATE TABLE t1 (


    created TIMESTAMP DEFAULT CURRENT_TIMESTAMP,



);
```

</script>



<script data-role="slide" data-markdown type="text/html">
# Uppdatera värden

```
UPDATE t1 SET value = 'Bb' WHERE id = 2;
UPDATE t1 SET value = 'Cc' WHERE id = 3;
```

</script>



<script data-role="slide" data-markdown type="text/html">
# Uppdatera värden...

```
mysql> SELECT * FROM t1;
+----+-------+---------------------+---------------------+---------+
| id | value | created             | updated             | deleted |
+----+-------+---------------------+---------------------+---------+
|  1 | A     | 2021-02-18 13:20:59 | NULL                | NULL    |
|  2 | Bb    | 2021-02-18 13:20:59 | 2021-02-18 13:21:56 | NULL    |
|  3 | Cc    | 2021-02-18 13:20:59 | 2021-02-18 13:22:48 | NULL    |
+----+-------+---------------------+---------------------+---------+
3 rows in set (0.00 sec)
```

</script>



<script data-role="slide" data-markdown type="text/html">
# Tidstämpel updated

```
CREATE TABLE t1 (



	updated TIMESTAMP DEFAULT NULL
							 ON UPDATE CURRENT_TIMESTAMP,

);
```

</script>



<script data-role="slide" data-markdown type="text/html">
# Radera värden (soft)

```
UPDATE t1 SET deleted = NOW() WHERE id = 3;
```

```
mysql> UPDATE t1 SET deleted = NOW() WHERE id = 3;
Query OK, 1 row affected (0.02 sec)
Rows matched: 1  Changed: 1  Warnings: 0
```

</script>



<script data-role="slide" data-markdown type="text/html">
# Radera värden...

```
mysql> SELECT * FROM t1;
+----+-------+---------------------+---------------------+---------------------+
| id | value | created             | updated             | deleted             |
+----+-------+---------------------+---------------------+---------------------+
|  1 | A     | 2021-02-18 13:20:59 | NULL                | NULL                |
|  2 | Bb    | 2021-02-18 13:20:59 | 2021-02-18 13:21:56 | NULL                |
|  3 | Cc    | 2021-02-18 13:20:59 | 2021-02-18 13:25:41 | 2021-02-18 13:25:41 |
+----+-------+---------------------+---------------------+---------------------+
3 rows in set (0.00 sec)
```

</script>



<script data-role="slide" data-markdown type="text/html">
# Tidstämpel deleted

```
CREATE TABLE t1 (





	deleted TIMESTAMP DEFAULT NULL
);
```

</script>



<script data-role="slide" data-markdown type="text/html">
# SELECT per status

* Visa de rader som är uppdaterade
* Visa de rader som är raderade
* Plocka fram vilka rader som är skapade men inte raderade

</script>



<script data-role="slide" data-markdown type="text/html">
# Rader som är uppdaterade

```
mysql> SELECT * FROM t1 WHERE updated IS NOT NULL;
+----+-------+---------------------+---------------------+---------------------+
| id | value | created             | updated             | deleted             |
+----+-------+---------------------+---------------------+---------------------+
|  2 | Bb    | 2021-02-18 13:20:59 | 2021-02-18 13:21:56 | NULL                |
|  3 | Cc    | 2021-02-18 13:20:59 | 2021-02-18 13:25:41 | 2021-02-18 13:25:41 |
+----+-------+---------------------+---------------------+---------------------+
2 rows in set (0.00 sec)
```

</script>



<script data-role="slide" data-markdown type="text/html">
# Rader som är raderade

```
mysql> SELECT * FROM t1 WHERE deleted IS NOT NULL;
+----+-------+---------------------+---------------------+---------------------+
| id | value | created             | updated             | deleted             |
+----+-------+---------------------+---------------------+---------------------+
|  3 | Cc    | 2021-02-18 13:20:59 | 2021-02-18 13:25:41 | 2021-02-18 13:25:41 |
+----+-------+---------------------+---------------------+---------------------+
1 row in set (0.00 sec)
```

</script>



<script data-role="slide" data-markdown type="text/html">
# Uppdaterade men inte raderade

```
mysql> SELECT * FROM t1
    -> WHERE
    ->     deleted IS NULL
    ->     AND updated IS NOT NULL
    -> ;
+----+-------+---------------------+---------------------+---------+
| id | value | created             | updated             | deleted |
+----+-------+---------------------+---------------------+---------+
|  2 | Bb    | 2021-02-18 13:20:59 | 2021-02-18 13:21:56 | NULL    |
+----+-------+---------------------+---------------------+---------+
1 row in set (0.00 sec)
```

</script>



<script data-role="slide" data-markdown type="text/html" class="titlepage center">
# Tidstämplar

* Kolumner ger "mening" (semantik) till radernas status

<p class="footnote">Exempelkoden för detta exemepl finns i https://github.com/dbwebb-se/databas/blob/master/example/sql/timestamp.sql.</p>

</script>



<script data-role="slide" data-markdown type="text/html" class="titlepage center">
# Programmera i databasen
</script>



<script data-role="slide" data-markdown type="text/html">
# Programmera i databasen

* Skapa ett API mot databasen
* Lagrade procedurer
* Triggers

</script>



<script data-role="slide" data-markdown type="text/html">
# Flytta pengar

```
-- PSUEDO KOD
SET @amount = 1.5;
SET @from   = '1111';
SET @to     = '2222';

START TRANSACTION;

SET @balance = (SELECT balance FROM account WHERE id = @from);
IF @balance < @amount THEN ROLLBACK;

UPDATE account SET balance = balance + @amount WHERE id = @to;
UPDATE account SET balance = balance - @amount WHERE id = @from;

COMMIT;
```

</script>



<script data-role="slide" data-markdown type="text/html">
# MySQL och SET

* Globala systemvariabler @@local_infile
* Användadefinierade variabler @amount
* Lokala variabler (compound statement)

</script>



<script data-role="slide" data-markdown type="text/html">
# Globala systemvariabler

```
SHOW VARIABLES;
SHOW VARIABLES LIKE '%cache%';
SHOW VARIABLES LIKE 'local_infile';

SELECT @@have_query_cache;
SELECT @@global.secure_file_priv;

SET GLOBAL local_infile = 1;
```

</script>



<script data-role="slide" data-markdown type="text/html">
# Användardefinierade variabler

```
SET @amount = 1.5;
SET @from   = '1111';
SET @to     = '2222';
SET @balance = (SELECT balance FROM account WHERE id = @from);

SELECT balance INTO @balance FROM account WHERE id = @from;
SELECT @balance;
```

</script>



<script data-role="slide" data-markdown type="text/html">
# Användardefinierade variabler...

* Löst typade
* Scope av sessionen/filen

</script>



<script data-role="slide" data-markdown type="text/html">
# Lokala variabler

```
BEGIN
	DECLARE a_balance INT;
    DECLARE a_id INT;
    DECLARE a_who VARCHAR(20) DEFAULT 'mos';

    SET a_id = 1111;
    SET a_who = 'MegaMos';

	SELECT balance INTO a_balance FROM account WHERE id = a_id;
    SELECT aWho, a_id, a_balance;
END
```
</script>



<script data-role="slide" data-markdown type="text/html">
# Lokala variabler...

* Hårt typade
* Scope av compound statement

</script>



<script data-role="slide" data-markdown type="text/html">
# Compound statement

```
BEGIN
	-- Programming code and SQL combined
END
```

</script>



<script data-role="slide" data-markdown type="text/html">
# Compound statement

* Inuti "lagrade program" (i databasen)
* Lagrade procedurer (stored procedures, sp)
* Triggers
* Funktioner (Used defined functions, udf)
* Event

</script>



<script data-role="slide" data-markdown type="text/html">
# Delimiter

```
DELIMITER ;;
CREATE PROCEDURE/TRIGGER/FUNCTION
BEGIN
    -- Statements
END;;
DELIMITER ;
```
</script>



<script data-role="slide" data-markdown type="text/html">
# Variabler

```
DELIMITER ;;
BEGIN
	DECLARE a_balance INT;
    DECLARE a_id INT;

    SET a_id = 1111;
    SET a_balance = (SELECT balance FROM account WHERE id = a_id);

	SELECT balance INTO a_balance FROM account WHERE id = a_id;
END;;
DELIMITER ;
```
</script>



<script data-role="slide" data-markdown type="text/html">
# Variabler...

* Mixa inte namngivning av lokala variabler och kolumn/tabellnamn

</script>



<script data-role="slide" data-markdown type="text/html">
# IF

```
BEGIN
	DECLARE aBalance INT DEFAULT 7;

    IF aBalance < 0 THEN
        SELECT 'A';
    ELSEIF aBalance < 3 THEN
        SELECT 'B';
    ELSE
        SELECT 'C';
    END IF;
END;;
```
</script>



<script data-role="slide" data-markdown type="text/html">
# Mer konstruktioner

* LOOP, REPEAT/UNTIL, WHILE
* CASE/WHEN/ELSE
* LEAVE/RETURN
* CURSOR/OPEN/FETCH/CLOSE
* CONDITION/HANDLER/SIGNAL

</script>



<script data-role="slide" data-markdown type="text/html">
# Lagrad procedur
</script>



<script data-role="slide" data-markdown type="text/html">
# Lagrad procedur

* Stored procedure, SP
* Litet program som lagras i databasen
* Anropas med CALL
* In, out, inout parametrar
* Leverera resultset(s)
* API mot databasen

</script>



<script data-role="slide" data-markdown type="text/html">
# En lagrad proc

```
DROP PROCEDURE IF EXISTS test_proc;

DELIMITER ;;
CREATE PROCEDURE test_proc ()
BEGIN
    -- Statements
END;;
DELIMITER ;

CALL test_proc();
```

</script>



<script data-role="slide" data-markdown type="text/html">
# En lagrad proc

```
CREATE PROCEDURE test_proc ()
BEGIN
    DECLARE a_balance INT DEFAULT 7;

    IF a_balance < 0 THEN
        SELECT 'A';
    ELSEIF a_balance < 3 THEN
        SELECT 'B';
    ELSE
        SELECT 'C';
    END IF;
END;;

CALL test_proc(); -- Ger resultset med 'C'
```

</script>



<script data-role="slide" data-markdown type="text/html">
# IN parametrar

```
CREATE PROCEDURE test_proc (
    p_balance INT
)
BEGIN
    DECLARE a_balance INT DEFAULT 7;

    SET a_balance = p_balance;

    -- IF statement
END;;

CALL test_proc(-1); -- 'A'
CALL test_proc(1);  -- 'B'
CALL test_proc(7);  -- 'C'
```

</script>



<script data-role="slide" data-markdown type="text/html">
# INOUT parametrar

```
CREATE PROCEDURE test_proc (
    INOUT p_balance INT
)
BEGIN
    SET p_balance = p_balance + 1;
END;;

SET @val = 1;
CALL test_proc(@val);
SELECT @val; -- 2
```

</script>



<script data-role="slide" data-markdown type="text/html">
# IN och OUT parametrar

```
CREATE PROCEDURE test_proc (
	IN p_balance INT,
    OUT p_sum INT
)
BEGIN
	SET p_sum = p_balance + 1;
END;;

SET @val = 0;
CALL test_proc(41, @val);
SELECT @val; -- 42
```

</script>



<script data-role="slide" data-markdown type="text/html">
# Resultsets

```
CREATE PROCEDURE test_proc (
	IN p_id INT
)
BEGIN
	SELECT * FROM account;
    SELECT balance FROM account WHERE id = p_id;
END;;

CALL test_proc(1111); -- 2 resultsets
```

</script>



<script data-role="slide" data-markdown type="text/html">
# Se detaljer om proc

```
SHOW PROCEDURE STATUS;
SHOW PROCEDURE STATUS LIKE '%money';

SHOW CREATE PROCEDURE move_money \G;
```

</script>



<script data-role="slide" data-markdown type="text/html">
# Felsök med varning

```
mysql> CALL edit_account('1337', 'Mega', 4200000);
Query OK, 1 row affected, 1 warning (0.00 sec)

SHOW WARNINGS;
```
</script>



<script data-role="slide" data-markdown type="text/html">
# Debugga

* Kommentera bort stycke
* (echo) SELECT "Meddelande"
* Testa alltid i databasklienten, sedan i JavaScript

</script>



<script data-role="slide" data-markdown type="text/html">
# Varför proc?

* \+ Komplicerade konstruktioner i databasen
* \+ Dölj databasimplementation bakom API
* \+ Testbart API, enhetstesta
* \+ Rätt kompetens för rätt kodtyp
* \+ Var sak på sin plats (separation of concerns)

</script>



<script data-role="slide" data-markdown type="text/html">
# Nackdelar proc?

* \- Databasspecifik kod
* \- Kompabilitet mellan databaser
* \- Kräver utveckling, test och felsökningsmiljö

</script>



<script data-role="slide" data-markdown type="text/html">
# Kodexempel

* [example/sql/stored_procedure_slides.sql](https://github.com/dbwebb-se/databas/blob/master/example/sql/stored_procedure_slides.sql)

</script>



<script data-role="slide" data-markdown type="text/html">
# Trigger
</script>



<script data-role="slide" data-markdown type="text/html">
# Triggers sker på

* INSERT
* UPDATE
* DELETE

</script>



<script data-role="slide" data-markdown type="text/html">
# Triggers sker

* BEFORE
* AFTER

</script>



<script data-role="slide" data-markdown type="text/html">
# Tillgång till

* NEW (NEW.id, etc)
* OLD (OLD.id, etc)
* Raderna och kolumnernas värde ligger i variabel

</script>



<script data-role="slide" data-markdown type="text/html">
# Exempel

* Flytta pengar mellan konton
* Logga information om pengaflytten
* En händelselogg, transaktionslogg

```
CALL move_money('1111', '2222', 1.5);
SELECT * FROM log ORDER BY `when` DESC LIMIT 2;
```

</script>



<script data-role="slide" data-markdown type="text/html">
# Exempel...

```
DROP TRIGGER IF EXISTS log_balance_update;

CREATE TRIGGER log_balance_update
AFTER UPDATE
ON account FOR EACH ROW
    INSERT INTO account_log (`what`, `account`, `balance`, `amount`)
        VALUES ('trigger', NEW.id, NEW.balance, NEW.balance - OLD.balance);
```

</script>



<script data-role="slide" data-markdown type="text/html">
# Exempel compound statement

```
DROP TRIGGER IF EXISTS trigger_test1;
DELIMITER ;;

CREATE TRIGGER trigger_test1
AFTER UPDATE
ON account FOR EACH ROW
BEGIN
    -- Some compound statements
END
;;

DELIMITER ;
```

</script>



<script data-role="slide" data-markdown type="text/html">
# Summering trigger

* INSERT, UPDATE, DELETE
* BEFORE, AFTER
* NEW, OLD
* Med eller utan compound statement

</script>



<script data-role="slide" data-markdown type="text/html">
# Admin

```
SHOW TRIGGERS
    [{FROM | IN} db_name]
    [LIKE 'pattern' | WHERE expr]

SHOW TRIGGERS;
SHOW TRIGGERS LIKE 'account' \G;
SHOW TRIGGERS FROM dbwebb \G;
```

</script>



<script data-role="slide" data-markdown type="text/html">
# Varför triggers?

* \+ Får saker att hända automatiskt
* \+ Mindre kod i databasen
* \- Saker händer automatiskt
* \- Magisk osynlig kod i databasen
* \- Glömmer bort dem

</script>



<script data-role="slide" data-markdown type="text/html">
# Felsök trigger

* Glöm inte bort att du har dem...
* Udda fel, kolla om du har triggers på din db/tabell
* Droppa alla triggers och försök igen
* (echo) Logga triggers genom skriva till debug tabell

</script>



<script data-role="slide" data-markdown type="text/html">
# Summering

* Tänk gränssnitt/API mot databasen
* Mer intelligens i databasen (?)
* Compound statements
* Lagrade procedurer
* Triggers

</script>



<script data-role="slide" data-markdown type="text/html">
# Exempel på triggers

* [example/sql/triggers_insert_update_delete.sql](https://github.com/dbwebb-se/databas/blob/master/example/sql/triggers_insert_update_delete.sql)

</script>



<script data-role="slide" data-markdown type="text/html">
# JavaScript mot SP

* Resultset innehåller två delar
    * Resultset från query(ies)
    * Status för anropet
* Hur hanteras OUT, INOUT?

Tror inte artikeln om JS/SP tar upp alla olika fall. Gör testprogram som visar.

</script>



<script data-role="slide" data-markdown type="text/html">
# Avslutningsvis

* Frågor på det?

</script>



<script data-role="slide" data-markdown type="text/html">
<!-- empty slide by intention -->
</script>
